<?xml version="1.0" encoding="UTF-8"?>
<!--
  AFLAC Prompt: Artifact Search
  Searches Glean index for user-provided artifact locations (PRDs, wireframes, API specs, etc.)

  Domain: artifact-intelligence
  Bounded Context: artifact-intelligence
  UV Target: make artifact-search
-->
<prompt xmlns="http://aflac.glean.com/prompts/v1" version="1.0">
  <metadata>
    <name>artifact-search</name>
    <version>1.0</version>
    <sdlc_domain>artifact-intelligence</sdlc_domain>
    <bounded_context>artifact-intelligence</bounded_context>
    <stateful>true</stateful>
    <purpose>Search Glean index for user-provided artifacts (PRDs, wireframes, API specs) and index discovered locations</purpose>
    <created>2026-01-21</created>
    <author>AFLAC System</author>
    <tags>
      <tag>glean</tag>
      <tag>search</tag>
      <tag>artifacts</tag>
      <tag>discovery</tag>
    </tags>
  </metadata>

  <primary_goal>
    Search the Glean Knowledge Graph for user-specified artifact types and locations, building an indexed catalog of discoverable requirements documents, design artifacts, and technical specifications that feed into the SDLC workflow.
    <audience>Product managers, engineers, and architects seeking requirements and design artifacts</audience>
    <tone>Systematic, discovery-focused, and comprehensive</tone>
  </primary_goal>

  <role>Artifact Discovery Specialist and Glean Search Expert</role>

  <context>
    This prompt initiates the Artifact Intelligence domain workflow by searching Glean for user-specified artifact types. Users provide artifact type hints (PRD, wireframe, API spec, etc.) and optional location hints (folder paths, owners, date ranges). The prompt uses Glean MCP tools to discover and catalog these artifacts for downstream processing.

    The discovered artifacts are stored in a structured index that feeds into the artifact-process, artifact-refine, and story-refine prompts, ultimately updating the implementation backlog.
  </context>

  <uv_integration>
    <make_target>artifact-search</make_target>
    <parameters>
      <parameter name="ARTIFACT_TYPE" type="enum" required="true" description="Type of artifact to search: prd, wireframe, api-spec, design-doc, tech-spec, user-story, all"/>
      <parameter name="OWNER" type="string" required="false" description="Filter by document owner (name or 'me')"/>
      <parameter name="FOLDER" type="string" required="false" description="Folder path or pattern to search within"/>
      <parameter name="DATE_RANGE" type="string" required="false" description="Date filter: past_week, past_month, YYYY-MM-DD:YYYY-MM-DD"/>
      <parameter name="APP" type="string" required="false" description="Filter by app: gdrive, confluence, notion, jira"/>
      <parameter name="OUTPUT" type="path" required="false" default="artifacts/discovered_index.yaml" description="Output path for artifact index"/>
    </parameters>
    <idempotency_guarantee>true</idempotency_guarantee>
    <determinism>
      <description>Same search parameters return same artifact index (cached for 1 hour)</description>
      <hash_inputs>ARTIFACT_TYPE,OWNER,FOLDER,DATE_RANGE,APP</hash_inputs>
      <cache_ttl_seconds>3600</cache_ttl_seconds>
    </determinism>
    <exit_codes>
      <code value="0" category="success">Artifacts discovered and indexed successfully</code>
      <code value="1" category="validation">Invalid artifact type or parameters</code>
      <code value="2" category="dependency">Glean MCP unavailable</code>
      <code value="3" category="runtime">Search execution error</code>
      <code value="10" category="domain">No artifacts found matching criteria</code>
    </exit_codes>
  </uv_integration>

  <glean_integration>
    <mcp_tools>
      <tool name="mcp__glean_default__search" primary="true">
        <purpose>Primary document discovery across all indexed sources</purpose>
        <query_pattern>type:{doc_type} owner:{owner} updated:{date_range}</query_pattern>
      </tool>
      <tool name="mcp__glean_default__read_document">
        <purpose>Retrieve full content of discovered artifacts for metadata extraction</purpose>
      </tool>
      <tool name="mcp__glean_default__user_activity">
        <purpose>Discover artifacts through user activity patterns</purpose>
      </tool>
    </mcp_tools>
    <artifact_types>
      <artifact type="prd" search_pattern="PRD OR 'product requirements' OR 'requirements document'" app_filter="gdrive,confluence,notion"/>
      <artifact type="wireframe" search_pattern="wireframe OR mockup OR prototype OR figma" app_filter="gdrive,figma"/>
      <artifact type="api-spec" search_pattern="'API spec' OR 'API specification' OR swagger OR openapi" app_filter="gdrive,confluence,github"/>
      <artifact type="design-doc" search_pattern="'design doc' OR 'technical design' OR 'architecture'" app_filter="gdrive,confluence"/>
      <artifact type="tech-spec" search_pattern="'tech spec' OR 'technical specification' OR RFC" app_filter="gdrive,confluence"/>
      <artifact type="user-story" search_pattern="'user story' OR 'as a user' OR acceptance criteria" app_filter="jira,confluence"/>
    </artifact_types>
    <data_sources>
      <source name="Google Drive" connector="gdrive" priority="1"/>
      <source name="Confluence" connector="confluence" priority="2"/>
      <source name="Notion" connector="notion" priority="3"/>
      <source name="Jira" connector="jira" priority="4"/>
      <source name="Figma" connector="figma" priority="5"/>
      <source name="GitHub" connector="github" priority="6"/>
    </data_sources>
  </glean_integration>

  <claude_orchestration>
    <execution_mode>interactive</execution_mode>
    <state_management>
      <state_file>artifacts/discovered_index.yaml</state_file>
      <read_on_start>true</read_on_start>
      <write_on_complete>true</write_on_complete>
      <state_schema>schema/artifact-index-schema.yaml</state_schema>
    </state_management>
    <feedback_loop>
      <user_input_required>true</user_input_required>
      <question_file>artifacts/search_clarifications.yaml</question_file>
      <answer_integration>Refine search based on user feedback</answer_integration>
    </feedback_loop>
    <skill_triggers>
      <skill name="artifact-search" command="/artifact-search" trigger_condition="User requests artifact discovery"/>
    </skill_triggers>
    <workflow_transitions>
      <transition from="artifact-search" to="artifact-process" condition="Artifacts discovered" auto="false"/>
      <transition from="artifact-search" to="artifact-search" condition="User refines search" auto="false"/>
    </workflow_transitions>
  </claude_orchestration>

  <domain_knowledge>
    <area>Glean Knowledge Graph search patterns and MCP tool usage</area>
    <area>Enterprise document taxonomy and artifact classification</area>
    <area>SDLC artifact types and their role in requirements gathering</area>
    <area>Search optimization and relevance ranking</area>
  </domain_knowledge>

  <steps>
    <step id="1">
      <name>Parse Search Parameters</name>
      <description>Validate and normalize input parameters including artifact type, owner, folder, date range, and app filters</description>
      <make_command>make artifact-search ARTIFACT_TYPE=prd</make_command>
      <acceptance_criteria>
        <criterion>All required parameters are present and valid</criterion>
        <criterion>Artifact type maps to known search pattern</criterion>
      </acceptance_criteria>
    </step>
    <step id="2">
      <name>Load Existing Index</name>
      <description>Read current artifact index to enable incremental discovery and avoid duplicates</description>
      <acceptance_criteria>
        <criterion>Existing index loaded or empty index initialized</criterion>
        <criterion>Index schema validated</criterion>
      </acceptance_criteria>
    </step>
    <step id="3">
      <name>Execute Glean Search</name>
      <description>Use mcp__glean_default__search with constructed query based on artifact type and filters</description>
      <make_command>Internally calls Glean MCP search tool</make_command>
      <acceptance_criteria>
        <criterion>Search query executed successfully</criterion>
        <criterion>Results returned with metadata (title, URL, owner, updated)</criterion>
      </acceptance_criteria>
    </step>
    <step id="4">
      <name>Enrich Artifact Metadata</name>
      <description>For each discovered artifact, extract additional metadata including document type confidence, related artifacts, and key sections</description>
      <acceptance_criteria>
        <criterion>Each artifact has classification confidence score</criterion>
        <criterion>Related artifacts identified via content analysis</criterion>
      </acceptance_criteria>
    </step>
    <step id="5">
      <name>Merge and Deduplicate</name>
      <description>Merge new discoveries with existing index, deduplicating by URL and preserving history</description>
      <acceptance_criteria>
        <criterion>No duplicate URLs in final index</criterion>
        <criterion>Discovery timestamp recorded for new artifacts</criterion>
      </acceptance_criteria>
    </step>
    <step id="6">
      <name>Generate Discovery Report</name>
      <description>Output summary of discovered artifacts with statistics and recommended next steps</description>
      <acceptance_criteria>
        <criterion>Summary includes count by artifact type</criterion>
        <criterion>New vs existing artifact counts shown</criterion>
      </acceptance_criteria>
    </step>
  </steps>

  <constraints>
    <constraint>Only search artifacts the user has permission to access via Glean ACLs</constraint>
    <constraint>Respect rate limits on Glean MCP tool calls</constraint>
    <constraint>Do not modify discovered documents - read-only discovery</constraint>
    <constraint>Preserve existing index entries - additive updates only</constraint>
    <constraint>Cache search results to enable deterministic re-runs</constraint>
  </constraints>

  <validation_rules>
    <rule severity="error">ARTIFACT_TYPE must be one of: prd, wireframe, api-spec, design-doc, tech-spec, user-story, all</rule>
    <rule severity="error">Output YAML must be valid and match artifact index schema</rule>
    <rule severity="warning">At least one artifact should be discovered for valid search parameters</rule>
    <rule severity="info">Search should complete within 60 seconds</rule>
  </validation_rules>

  <output_format>
    <section name="Discovery Summary" format="markdown">Count of artifacts by type, new vs existing, date range covered</section>
    <section name="Artifact Index" format="yaml">Structured YAML with all discovered artifacts and metadata</section>
    <section name="Recommended Actions" format="markdown">Next steps: process artifacts, refine search, or escalate questions</section>
  </output_format>

  <examples>
    <example type="good">
      <input>make artifact-search ARTIFACT_TYPE=prd OWNER=me DATE_RANGE=past_month</input>
      <output>
Discovered 12 PRD artifacts:
- 8 new artifacts indexed
- 4 existing artifacts updated

Top artifacts:
1. Q1 2026 Feature Roadmap PRD (gdrive, updated 2026-01-15)
2. Authentication Redesign PRD (confluence, updated 2026-01-10)
...

Recommended: Run `make artifact-process` to extract requirements
      </output>
      <explanation>Successful search with owner and date filters, incremental update to existing index</explanation>
    </example>
    <example type="bad">
      <input>make artifact-search ARTIFACT_TYPE=unknown</input>
      <output>Error: Invalid artifact type 'unknown'. Valid types: prd, wireframe, api-spec, design-doc, tech-spec, user-story, all</output>
      <explanation>Invalid artifact type fails validation before search execution</explanation>
    </example>
  </examples>

  <reasoning>
    When executing artifact search:
    1. First validate all input parameters to fail fast on invalid requests
    2. Load existing index to enable incremental discovery
    3. Construct optimized Glean query using artifact type patterns and filters
    4. Execute search and handle pagination for large result sets
    5. Enrich each result with classification confidence
    6. Merge results while preserving index integrity
    7. Generate actionable summary for user decision-making
  </reasoning>

  <observability>
    <metrics>
      <metric name="artifact_search_count" type="counter">
        <description>Number of artifact searches executed</description>
        <unit>count</unit>
        <aggregation>sum</aggregation>
      </metric>
      <metric name="artifacts_discovered" type="counter">
        <description>Number of new artifacts discovered</description>
        <unit>count</unit>
        <aggregation>sum</aggregation>
      </metric>
      <metric name="search_latency" type="histogram">
        <description>Time to complete artifact search</description>
        <unit>seconds</unit>
        <aggregation>p50,p95,p99</aggregation>
      </metric>
    </metrics>
    <slo>
      <target metric="search_latency" threshold="&lt;60s" window="1h"/>
      <target metric="artifacts_discovered" threshold="&gt;0 for 80% of searches" window="1d"/>
    </slo>
  </observability>
</prompt>
